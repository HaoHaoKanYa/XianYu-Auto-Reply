<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登录 - 闲鱼自动回复管理系统</title>
  <link rel="stylesheet" href="/static/lib/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="/static/lib/bootstrap-icons/bootstrap-icons.css">
  <style>
    /* Vercel 风格登录页面（简约白色 - 柔和色调） */
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --bg-primary: #ffffff;
      --bg-secondary: #fafafa;
      --bg-card: #ffffff;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border-color: #eaeaea;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-secondary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      -webkit-font-smoothing: antialiased;
    }

    .login-container {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      width: 100%;
      max-width: 420px;
    }

    .login-header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 2rem;
      text-align: center;
    }

    .login-header i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }

    .login-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: -0.02em;
    }

    .login-header p {
      margin: 0.5rem 0 0 0;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .login-body {
      padding: 2rem;
    }

    .login-tabs .btn-group {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 0.25rem;
    }

    .login-tabs .btn {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      padding: 0.5rem 0.75rem;
      transition: all 0.2s ease;
    }

    .login-tabs .btn-check:checked+.btn {
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
      background: var(--bg-primary);
      outline: none;
    }

    .form-control::placeholder {
      color: var(--text-secondary);
    }

    .btn-login {
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      width: 100%;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-login:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(0, 112, 243, 0.3);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .input-group {
      position: relative;
      margin-bottom: 1rem;
    }

    .input-group i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      z-index: 10;
    }

    .input-group .form-control {
      padding-left: 2.75rem;
    }

    .form-check-input {
      background-color: var(--bg-primary);
      border-color: var(--border-color);
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .form-check-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .alert {
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .alert-danger {
      border-color: #fca5a5;
      background: #fee2e2;
      color: #991b1b;
    }

    .alert-info {
      border-color: #93c5fd;
      background: #dbeafe;
      color: #1e40af;
    }

    .loading {
      display: none;
    }

    .loading.show {
      display: inline-block;
    }

    #defaultLoginInfo {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    #defaultLoginInfo code {
      background: var(--bg-primary);
      color: var(--primary-color);
      border: 1px solid var(--border-color);
    }

    #registerSection a {
      color: var(--primary-color);
    }

    #registerSection a:hover {
      text-decoration: underline;
    }

    .text-muted {
      color: var(--text-secondary) !important;
    }

    .btn-outline-primary {
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
    }

    .btn-outline-primary:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline-secondary {
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-secondary);
    }

    .btn-outline-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    .bg-light {
      background: var(--bg-secondary) !important;
    }

    .login-tabs .btn-group {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 0.25rem;
    }

    .login-tabs .btn {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      padding: 0.5rem 0.75rem;
      transition: all 0.2s ease;
    }

    .login-tabs .btn-check:checked+.btn {
      background: var(--bg-primary);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .rounded-3 {
      border-radius: 8px !important;
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-header">
      <i class="bi bi-chat-dots-fill fs-1 mb-3"></i>
      <h2>闲鱼自动回复</h2>
      <p>管理系统登录</p>
    </div>

    <div class="login-body">
      <!-- 登录方式选择 -->
      <div class="login-tabs mb-4">
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="loginType" id="usernameLogin" value="username" checked>
          <label class="btn btn-outline-primary" for="usernameLogin">用户名/密码</label>

          <input type="radio" class="btn-check" name="loginType" id="emailPasswordLogin" value="email-password">
          <label class="btn btn-outline-primary" for="emailPasswordLogin">邮箱/密码</label>

          <input type="radio" class="btn-check" name="loginType" id="emailCodeLogin" value="email-code">
          <label class="btn btn-outline-primary" for="emailCodeLogin">邮箱/验证码</label>
        </div>
      </div>

      <form id="loginForm">
        <!-- 用户名/密码登录 -->
        <div id="usernameLoginForm" class="login-form-section">
          <div class="input-group">
            <i class="bi bi-person-fill"></i>
            <input type="text" class="form-control" id="username" placeholder="请输入用户名" autocomplete="username">
          </div>

          <div class="input-group">
            <i class="bi bi-lock-fill"></i>
            <input type="password" class="form-control" id="password" placeholder="请输入密码"
              autocomplete="current-password">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="rememberMe" checked>
            <label class="form-check-label" for="rememberMe">
              记住我（7天内自动登录）
            </label>
          </div>
        </div>

        <!-- 邮箱/密码登录 -->
        <div id="emailPasswordLoginForm" class="login-form-section" style="display: none;">
          <div class="input-group">
            <i class="bi bi-envelope-fill"></i>
            <input type="email" class="form-control" id="emailForPassword" placeholder="请输入邮箱地址" autocomplete="email">
          </div>

          <div class="input-group">
            <i class="bi bi-lock-fill"></i>
            <input type="password" class="form-control" id="emailPassword" placeholder="请输入密码"
              autocomplete="current-password">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="rememberMeEmail" checked>
            <label class="form-check-label" for="rememberMeEmail">
              记住我（7天内自动登录）
            </label>
          </div>
        </div>

        <!-- 邮箱/验证码登录 -->
        <div id="emailCodeLoginForm" class="login-form-section" style="display: none;">
          <div class="input-group">
            <i class="bi bi-envelope-fill"></i>
            <input type="email" class="form-control" id="emailForCode" placeholder="请输入邮箱地址">
          </div>

          <!-- 图形验证码 -->
          <div class="mb-3">
            <label class="form-label">图形验证码</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control" id="captchaCode" placeholder="输入4位验证码" maxlength="4">
              </div>
              <div class="col-5">
                <div class="captcha-container" style="position: relative;">
                  <img id="captchaImage" src="" alt="图形验证码"
                    style="width: 100%; height: 38px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;"
                    onclick="refreshCaptcha()">
                  <div id="captchaLoading" class="text-center"
                    style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-text">
              <span id="captchaStatus">请输入图形验证码，点击图片可刷新</span>
            </div>
          </div>

          <!-- 邮箱验证码 -->
          <div class="input-group">
            <input type="text" class="form-control" id="verificationCode" placeholder="输入6位验证码" maxlength="6">
            <button type="button" class="btn btn-outline-secondary" id="sendCodeBtn" onclick="sendVerificationCode()"
              disabled>
              发送验证码
            </button>
          </div>
          <div class="form-text mb-3">
            <span id="codeStatus">请先验证图形验证码</span>
          </div>
        </div>

        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="errorMessage"></span>
        </div>

        <!-- 自动登录提示 -->
        <div id="autoLoginAlert" class="alert alert-info d-none" role="alert">
          <i class="bi bi-info-circle-fill me-2"></i>
          <span id="autoLoginMessage">检测到记住的登录信息，正在自动登录...</span>
        </div>

        <button type="submit" class="btn btn-primary btn-login">
          <span class="loading spinner-border spinner-border-sm me-2" role="status"></span>
          <span id="loginText">登录</span>
        </button>

        <!-- 清除记住的登录信息 -->
        <div class="text-center mt-3" id="clearRememberSection" style="display: none;">
          <a href="javascript:void(0)" onclick="clearRememberLogin()" class="text-muted text-decoration-none">
            <i class="bi bi-x-circle me-1"></i>
            <small>清除记住的登录信息</small>
          </a>
        </div>
      </form>

      <!-- 注册链接 -->
      <div id="registerSection" class="text-center mt-3">
        <span class="text-muted">还没有账号？</span>
        <a href="/register.html" class="text-decoration-none">
          <i class="bi bi-person-plus me-1"></i>立即注册
        </a>
      </div>

      <!-- 默认账号提示 -->
      <div id="defaultLoginInfo" class="mt-4 p-3 bg-light rounded-3">
        <div class="text-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            默认登录账号
          </small>
        </div>
        <div class="mt-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">用户名：</small>
            <code class="bg-white px-2 py-1 rounded">admin</code>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">密码：</small>
            <code class="bg-white px-2 py-1 rounded">admin123</code>
          </div>
        </div>
        <div class="text-center mt-2">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillDefaultCredentials()">
            <i class="bi bi-arrow-down-circle me-1"></i>
            使用默认账号
          </button>
        </div>
      </div>

    </div>
  </div>

  <script src="/static/lib/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const loading = document.querySelector('.loading');
    const loginText = document.getElementById('loginText');

    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.remove('d-none');
    }

    function hideError() {
      errorAlert.classList.add('d-none');
    }

    function setLoading(isLoading) {
      if (isLoading) {
        loading.classList.add('show');
        loginText.textContent = '登录中...';
        loginForm.querySelector('button').disabled = true;
      } else {
        loading.classList.remove('show');
        loginText.textContent = '登录';
        loginForm.querySelector('button').disabled = false;
      }
    }

    // 填充默认登录凭据
    function fillDefaultCredentials() {
      document.getElementById('username').value = 'admin';
      document.getElementById('password').value = 'admin123';
      hideError();

      // 添加一个小动画效果
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');

      usernameInput.style.backgroundColor = '#e3f2fd';
      passwordInput.style.backgroundColor = '#e3f2fd';

      setTimeout(() => {
        usernameInput.style.backgroundColor = '';
        passwordInput.style.backgroundColor = '';
      }, 1000);
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      setLoading(true);

      const loginType = document.querySelector('input[name="loginType"]:checked').value;
      let loginData = {};

      try {
        if (loginType === 'username') {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          if (!username || !password) {
            showError('请输入用户名和密码');
            return;
          }

          loginData = { username, password };
        } else if (loginType === 'email-password') {
          const email = document.getElementById('emailForPassword').value;
          const password = document.getElementById('emailPassword').value;

          if (!email || !password) {
            showError('请输入邮箱和密码');
            return;
          }

          if (!validateEmail(email)) {
            showError('请输入有效的邮箱地址');
            return;
          }

          loginData = { email, password };
        } else if (loginType === 'email-code') {
          const email = document.getElementById('emailForCode').value;
          const verificationCode = document.getElementById('verificationCode').value;

          if (!captchaVerified) {
            showError('请先验证图形验证码');
            return;
          }

          if (!email) {
            showError('请输入邮箱地址');
            return;
          }

          if (!validateEmail(email)) {
            showError('请输入有效的邮箱地址');
            return;
          }

          if (!verificationCode || verificationCode.length !== 6) {
            showError('请输入6位验证码');
            return;
          }

          loginData = { email, verification_code: verificationCode };
        }

        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(loginData)
        });

        const result = await response.json();

        if (result.success) {
          // 保存token到localStorage
          localStorage.setItem('auth_token', result.token);

          // 保存用户信息到localStorage
          const userInfo = {
            user_id: result.user_id,
            username: result.username,
            is_admin: result.is_admin
          };
          localStorage.setItem('user_info', JSON.stringify(userInfo));

          // 处理"记住我"功能
          if (loginType === 'username') {
            const rememberMe = document.getElementById('rememberMe').checked;
            if (rememberMe) {
              // 保存登录信息（7天有效期）
              const rememberData = {
                username: loginData.username,
                password: loginData.password,
                loginType: 'username',
                timestamp: Date.now()
              };
              localStorage.setItem('remember_login', JSON.stringify(rememberData));
            } else {
              // 清除记住的登录信息
              localStorage.removeItem('remember_login');
            }
          } else if (loginType === 'email-password') {
            const rememberMe = document.getElementById('rememberMeEmail').checked;
            if (rememberMe) {
              // 保存登录信息（7天有效期）
              const rememberData = {
                email: loginData.email,
                password: loginData.password,
                loginType: 'email-password',
                timestamp: Date.now()
              };
              localStorage.setItem('remember_login', JSON.stringify(rememberData));
            } else {
              // 清除记住的登录信息
              localStorage.removeItem('remember_login');
            }
          }

          // 检查是否有重定向URL
          const redirectUrl = localStorage.getItem('redirectAfterLogin');
          if (redirectUrl) {
            // 清除重定向URL
            localStorage.removeItem('redirectAfterLogin');
            // 跳转到原来的页面
            window.location.href = redirectUrl;
          } else {
            // 默认跳转到管理页面
            window.location.href = '/admin';
          }
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('登录失败，请检查网络连接');
      } finally {
        setLoading(false);
      }
    });

    // 清除记住的登录信息
    function clearRememberLogin() {
      if (confirm('确定要清除记住的登录信息吗？下次登录需要重新输入账号密码。')) {
        localStorage.removeItem('remember_login');
        document.getElementById('clearRememberSection').style.display = 'none';
        showError('已清除记住的登录信息');
        setTimeout(() => {
          hideError();
        }, 2000);
      }
    }

    // 自动登录功能
    async function tryAutoLogin() {
      // 首先检查是否已经有有效的token
      const token = localStorage.getItem('auth_token');
      if (token) {
        try {
          const response = await fetch('/verify', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const result = await response.json();
          if (result.authenticated) {
            // token有效，直接跳转
            window.location.href = '/admin';
            return;
          }
        } catch (error) {
          // token无效，清除
          localStorage.removeItem('auth_token');
        }
      }

      // 检查是否有记住的登录信息
      const rememberData = localStorage.getItem('remember_login');
      if (rememberData) {
        // 显示清除记住登录信息的链接
        document.getElementById('clearRememberSection').style.display = 'block';

        try {
          const data = JSON.parse(rememberData);
          const now = Date.now();
          const sevenDays = 7 * 24 * 60 * 60 * 1000; // 7天的毫秒数

          // 检查是否在7天有效期内
          if (now - data.timestamp < sevenDays) {
            console.log('发现记住的登录信息，尝试自动登录...');

            // 显示自动登录提示
            const autoLoginAlert = document.getElementById('autoLoginAlert');
            autoLoginAlert.classList.remove('d-none');
            const loginText = document.getElementById('loginText');
            loginText.textContent = '自动登录中...';
            setLoading(true);

            // 根据登录类型构造登录数据
            let loginData = {};
            if (data.loginType === 'username') {
              loginData = {
                username: data.username,
                password: data.password
              };
              // 填充表单（让用户看到）
              document.getElementById('username').value = data.username;
              document.getElementById('password').value = '••••••••';
            } else if (data.loginType === 'email-password') {
              loginData = {
                email: data.email,
                password: data.password
              };
              // 切换到邮箱登录
              document.getElementById('emailPasswordLogin').checked = true;
              switchLoginType();
              document.getElementById('emailForPassword').value = data.email;
              document.getElementById('emailPassword').value = '••••••••';
            }

            // 延迟1秒后自动登录，让用户看到提示
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 尝试自动登录
            const response = await fetch('/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(loginData)
            });

            const result = await response.json();

            if (result.success) {
              // 保存token
              localStorage.setItem('auth_token', result.token);

              // 保存用户信息
              const userInfo = {
                user_id: result.user_id,
                username: result.username,
                is_admin: result.is_admin
              };
              localStorage.setItem('user_info', JSON.stringify(userInfo));

              // 更新记住的登录信息时间戳
              data.timestamp = Date.now();
              localStorage.setItem('remember_login', JSON.stringify(data));

              // 显示成功提示
              document.getElementById('autoLoginMessage').textContent = '自动登录成功，正在跳转...';

              // 跳转到管理页面
              setTimeout(() => {
                window.location.href = '/admin';
              }, 500);
            } else {
              // 自动登录失败，清除记住的信息
              localStorage.removeItem('remember_login');
              autoLoginAlert.classList.add('d-none');
              setLoading(false);
              loginText.textContent = '登录';
              document.getElementById('clearRememberSection').style.display = 'none';
              showError('自动登录失败: ' + result.message);
              console.log('自动登录失败:', result.message);
            }
          } else {
            // 超过7天，清除记住的信息
            localStorage.removeItem('remember_login');
            document.getElementById('clearRememberSection').style.display = 'none';
            console.log('记住的登录信息已过期');
          }
        } catch (error) {
          console.error('自动登录出错:', error);
          localStorage.removeItem('remember_login');
          document.getElementById('clearRememberSection').style.display = 'none';
          setLoading(false);
        }
      }
    }

    // 页面加载时尝试自动登录
    tryAutoLogin();

    // 登录方式切换相关变量
    let captchaVerified = false;
    let countdownTimer = null;
    let countdownSeconds = 0;
    let sessionId = generateSessionId();

    // 生成会话ID
    function generateSessionId() {
      return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    // 登录方式切换
    function switchLoginType() {
      const loginType = document.querySelector('input[name="loginType"]:checked').value;

      // 隐藏所有表单
      document.querySelectorAll('.login-form-section').forEach(section => {
        section.style.display = 'none';
      });

      // 显示对应表单
      if (loginType === 'username') {
        document.getElementById('usernameLoginForm').style.display = 'block';
      } else if (loginType === 'email-password') {
        document.getElementById('emailPasswordLoginForm').style.display = 'block';
      } else if (loginType === 'email-code') {
        document.getElementById('emailCodeLoginForm').style.display = 'block';
        // 每次切换到邮箱验证码登录时都加载验证码
        loadCaptcha();
      }

      hideError();
    }

    // 加载图形验证码
    async function loadCaptcha() {
      const captchaImage = document.getElementById('captchaImage');
      const captchaLoading = document.getElementById('captchaLoading');
      const captchaStatus = document.getElementById('captchaStatus');

      captchaLoading.style.display = 'block';
      captchaImage.style.display = 'none';

      try {
        const response = await fetch('/generate-captcha', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ session_id: sessionId })
        });

        const result = await response.json();

        if (result.success) {
          captchaImage.src = result.captcha_image;
          captchaStatus.textContent = '请输入图形验证码，点击图片可刷新';
          captchaVerified = false;
          updateSendCodeButton();
        } else {
          captchaStatus.textContent = '图形验证码加载失败，请刷新页面重试';
        }
      } catch (error) {
        console.error('加载图形验证码失败:', error);
        captchaStatus.textContent = '图形验证码加载失败，请检查网络连接';
      } finally {
        captchaLoading.style.display = 'none';
        captchaImage.style.display = 'block';
      }
    }

    // 刷新图形验证码
    function refreshCaptcha() {
      loadCaptcha();
    }

    // 验证图形验证码
    async function verifyCaptcha() {
      const captchaCode = document.getElementById('captchaCode').value.trim();
      const captchaStatus = document.getElementById('captchaStatus');

      if (!captchaCode) {
        captchaStatus.textContent = '请输入图形验证码';
        captchaVerified = false;
        updateSendCodeButton();
        return;
      }

      try {
        const response = await fetch('/verify-captcha', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: sessionId,
            captcha_code: captchaCode
          })
        });

        const result = await response.json();

        if (result.success) {
          captchaStatus.innerHTML = '<span style="color: green;">✓ 图形验证码验证成功</span>';
          captchaVerified = true;
        } else {
          captchaStatus.innerHTML = '<span style="color: red;">✗ 图形验证码错误，请重新输入</span>';
          captchaVerified = false;
          refreshCaptcha(); // 自动刷新验证码
        }

        updateSendCodeButton();

      } catch (error) {
        console.error('验证图形验证码失败:', error);
        captchaStatus.innerHTML = '<span style="color: red;">验证失败，请检查网络连接</span>';
        captchaVerified = false;
        updateSendCodeButton();
      }
    }

    // 更新发送验证码按钮状态
    function updateSendCodeButton() {
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const email = document.getElementById('emailForCode').value.trim();
      const codeStatus = document.getElementById('codeStatus');

      if (captchaVerified && email && validateEmail(email)) {
        sendCodeBtn.disabled = false;
        codeStatus.textContent = '图形验证码已验证，可以发送邮箱验证码';
      } else {
        sendCodeBtn.disabled = true;
        if (!captchaVerified) {
          codeStatus.textContent = '请先验证图形验证码';
        } else if (!email) {
          codeStatus.textContent = '请先输入邮箱地址';
        } else if (!validateEmail(email)) {
          codeStatus.textContent = '请输入有效的邮箱地址';
        }
      }
    }

    // 邮箱格式验证
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // 开始倒计时
    function startCountdown() {
      countdownSeconds = 60;
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const codeStatus = document.getElementById('codeStatus');

      sendCodeBtn.disabled = true;

      countdownTimer = setInterval(() => {
        countdownSeconds--;
        sendCodeBtn.textContent = `重新发送 (${countdownSeconds}s)`;
        codeStatus.innerHTML = `<span class="countdown">验证码已发送，${countdownSeconds}秒后可重新发送</span>`;

        if (countdownSeconds <= 0) {
          clearInterval(countdownTimer);
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = '发送验证码';
          codeStatus.textContent = '可以重新发送验证码';
        }
      }, 1000);
    }

    // 发送邮箱验证码
    async function sendVerificationCode() {
      const email = document.getElementById('emailForCode').value.trim();

      if (!captchaVerified) {
        showError('请先验证图形验证码');
        return;
      }

      if (!email) {
        showError('请先输入邮箱地址');
        return;
      }

      if (!validateEmail(email)) {
        showError('请输入有效的邮箱地址');
        return;
      }

      try {
        const response = await fetch('/send-verification-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            type: 'login',
            session_id: sessionId
          })
        });

        const result = await response.json();

        if (result.success) {
          startCountdown();
        } else {
          showError(result.message);
        }
      } catch (error) {
        console.error('发送验证码失败:', error);
        showError('发送验证码失败，请检查网络连接');
      }
    }

    // 检查注册状态
    async function checkRegistrationStatus() {
      try {
        const response = await fetch('/registration-status');
        if (response.ok) {
          const data = await response.json();
          const registerSection = document.getElementById('registerSection');
          if (registerSection) {
            registerSection.style.display = data.enabled ? 'block' : 'none';
          }
        }
      } catch (error) {
        console.error('检查注册状态失败:', error);
        // 出错时默认显示注册链接
      }
    }

    // 检查默认登录信息显示状态
    async function checkLoginInfoStatus() {
      try {
        const response = await fetch('/login-info-status');
        const result = await response.json();

        const defaultLoginInfo = document.getElementById('defaultLoginInfo');
        if (result.enabled) {
          defaultLoginInfo.style.display = 'block';
        } else {
          defaultLoginInfo.style.display = 'none';
        }
      } catch (error) {
        console.error('检查登录信息显示状态失败:', error);
        // 出错时默认显示
        document.getElementById('defaultLoginInfo').style.display = 'block';
      }
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function () {
      // 检查注册状态
      checkRegistrationStatus();

      // 检查默认登录信息显示状态
      checkLoginInfoStatus();

      // 登录方式切换
      document.querySelectorAll('input[name="loginType"]').forEach(radio => {
        radio.addEventListener('change', switchLoginType);
      });

      // 图形验证码输入框事件
      const captchaCodeInput = document.getElementById('captchaCode');
      if (captchaCodeInput) {
        captchaCodeInput.addEventListener('input', function () {
          if (this.value.length === 4) {
            verifyCaptcha();
          } else {
            captchaVerified = false;
            updateSendCodeButton();
            document.getElementById('captchaStatus').textContent = '请输入4位图形验证码';
          }
        });
      }

      // 邮箱输入框事件
      const emailForCodeInput = document.getElementById('emailForCode');
      if (emailForCodeInput) {
        emailForCodeInput.addEventListener('input', updateSendCodeButton);
      }
    });
  </script>
</body>

</html>